<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unlocking the Power of the GLR Black London Collection</title>
    <style>
        :root {
            --primary-blue: #007bff;
            --primary-blue-dark: #0056b3;
            --text-dark: #333;
            --text-medium: #555;
            --text-light: #666;
            --bg-white: #fff;
            --bg-light-grey: #f9f9f9;
            --border-light: #ddd;
            --shadow-light: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            background-image: url('reels.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
        }

        .login-container {
            max-width: 960px;
            background-color: var(--bg-white);
            padding: 30px; /* Increased padding */
            box-shadow: 0 0 15px var(--shadow-light); /* Stronger shadow */
            border-radius: 8px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center; /* Center content within login box */
        }

        .main-content-wrapper {
            display: flex;
            flex-wrap: wrap; /* Allow columns to wrap on smaller screens */
            max-width: 1400px;
            margin: 50px auto;
            background-color: rgba(255, 255, 255, 0.9); /* Slightly more opaque */
            box-shadow: 0 0 15px var(--shadow-light); /* Stronger shadow */
            border-radius: 8px;
            overflow: hidden;
            min-height: 80vh;
        }

        .video-column {
            flex: 2;
            padding: 30px; /* Increased padding */
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.7); /* Slightly more transparent */
            box-sizing: border-box; /* Include padding in flex basis */
        }

        .article-column {
            flex: 1;
            padding: 30px; /* Increased padding */
            background-color: rgba(249, 249, 249, 0.8); /* Lighter grey with more opacity */
            border-left: 1px solid rgba(221, 221, 221, 0.6); /* Clearer separator */
            overflow-y: scroll;
            max-height: 80vh;
            box-sizing: border-box;
        }

        h1, h2 {
            text-align: center;
            color: var(--text-medium);
            margin-bottom: 25px; /* Added spacing below headings */
        }

        .login-container h1 {
            color: var(--text-dark); /* Darker for login heading */
            margin-bottom: 30px;
        }

        .article-column h2,
        .article-column h3 {
            text-align: left;
            color: var(--text-dark);
            margin-top: 1.8em; /* More space above */
            margin-bottom: 1em; /* More space below */
        }

        .login-form {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .login-form input[type="text"] {
            padding: 12px; /* Increased padding */
            margin-bottom: 20px; /* Increased spacing */
            border: 1px solid var(--border-light);
            border-radius: 6px; /* Slightly less rounded */
            width: 90%; /* Wider input */
            max-width: 350px; /* Increased max-width */
            font-size: 1.1em; /* Larger text */
        }

        .login-form button {
            background-color: var(--primary-blue);
            color: var(--bg-white);
            padding: 12px 25px; /* Increased padding */
            border: none;
            border-radius: 30px; /* More rounded, but not fully circular */
            cursor: pointer;
            font-size: 1.1em; /* Larger text */
            transition: background-color 0.2s ease-in-out; /* Smooth transition */
        }

        .login-form button:hover {
            background-color: var(--primary-blue-dark);
        }

        .login-error {
            color: red;
            text-align: center;
            margin-top: 15px;
            font-size: 0.95em;
        }

        .featured-video {
            margin-bottom: 40px; /* More space below featured video */
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            background-color: #000;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); /* Added shadow to video player */
        }

        .featured-video iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Slightly smaller min-width for more columns */
            gap: 25px; /* Increased gap */
            padding: 0;
        }

        .video-item {
            cursor: pointer;
            border: 1px solid rgba(221, 221, 221, 0.8); /* Stronger border */
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; /* Smooth transitions */
            background-color: rgba(249, 249, 249, 0.95); /* Nearly opaque white for video items */
            padding: 20px; /* Increased padding */
            box-sizing: border-box;
        }

        .video-item:hover {
            transform: translateY(-8px); /* More pronounced lift */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); /* More pronounced shadow */
        }

        .video-item-info {
            padding: 0;
        }

        .video-item-info h3 {
            font-size: 1.2em; /* Slightly larger title */
            margin: 0 0 8px 0; /* More space below title */
            color: var(--text-dark);
            white-space: normal;
            word-wrap: break-word;
        }

        .video-item-info p.description {
            font-size: 0.95em; /* Slightly larger description */
            color: var(--text-light);
            margin: 0 0 12px 0; /* More margin below description */
            line-height: 1.7; /* Increased line-height for better readability */
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: justify;
        }

        .video-item-info p.description.truncated {
            max-height: 5.1em; /* Approx 3 lines with new line-height */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .read-more-btn {
            display: inline-block;
            background: none;
            border: none;
            color: var(--primary-blue);
            cursor: pointer;
            font-size: 0.9em; /* Slightly larger read more */
            padding: 0;
            margin-top: 5px;
            text-align: left;
            text-decoration: underline;
            transition: color 0.2s ease-in-out;
        }

        .read-more-btn:hover {
            color: var(--primary-blue-dark);
        }

        .video-tags {
            margin-top: 15px; /* More space above tags */
            font-size: 0.85em; /* Slightly larger tags */
            color: #888;
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* More space between tags */
        }

        .video-tags span {
            background-color: #e6e6e6; /* Lighter tag background */
            padding: 4px 10px; /* More padding */
            border-radius: 15px; /* More rounded tags */
            color: #444; /* Darker tag text */
            white-space: nowrap;
        }

        /* Article specific styles */
        .article-column p,
        .article-column ul,
        .article-column li {
            line-height: 1.7; /* Unified line height for readability */
            margin-bottom: 1.2em; /* Consistent spacing between paragraphs and list items */
            text-align: justify;
            color: var(--text-light);
            font-size: 0.95em; /* Match video description font size */
        }
        .article-column ul {
            padding-left: 25px; /* Indent list items */
            margin-bottom: 1.5em; /* Ensure consistent spacing after the list */
        }
        .article-column li {
            margin-bottom: 0.7em; /* Slightly less space between list items */
        }
        .article-column strong {
            color: var(--text-dark);
        }

        .reel-reference {
            font-weight: bold;
            background-color: rgba(0, 123, 255, 0.08); /* Light blue background for reference */
            padding: 3px 7px; /* Adjusted padding */
            border-radius: 5px;
            display: inline-block;
            margin: 0 5px 5px 0; /* Added margin for spacing between wrapped elements */
            font-size: 0.98em; /* Slightly larger to enhance visibility */
            color: var(--primary-blue); /* Text color for link */
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .reel-reference:hover {
            background-color: rgba(0, 123, 255, 0.15); /* Darker background on hover */
            color: var(--primary-blue-dark);
        }

        /* Search Bar Styles */
        .search-container {
            margin-top: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .search-container input[type="text"] {
            width: 90%;
            max-width: 550px;
            padding: 12px 20px; /* Increased padding */
            border: 1px solid #bbb; /* Slightly darker border */
            border-radius: 25px; /* More rounded */
            font-size: 1.05em; /* Slightly larger font */
            outline: none;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.1); /* More prominent inner shadow */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .search-container input[type="text"]:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 8px rgba(0,123,255,0.4); /* More prominent glow */
        }

        .search-message {
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--text-medium);
            line-height: 1.6;
            max-width: 800px; /* Constrain message width */
            margin-left: auto;
            margin-right: auto;
        }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .main-content-wrapper {
                flex-direction: column; /* Stack columns vertically */
                margin: 30px auto;
            }

            .video-column, .article-column {
                flex: none; /* Remove flex sizing */
                width: 100%; /* Take full width */
                max-height: none; /* Remove max-height for scrolling issues */
                overflow-y: visible; /* Allow content to push height */
                padding: 20px;
            }

            .article-column {
                border-left: none;
                border-top: 1px solid rgba(221, 221, 221, 0.6); /* Add top border for separation */
            }

            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); /* Adjust grid for smaller screens */
            }

            .login-container {
                padding: 20px;
            }

            .login-form input[type="text"] {
                width: 90%;
            }
        }

        @media (max-width: 576px) {
            .login-container {
                max-width: 90%;
            }

            .login-form input[type="text"] {
                max-width: 280px;
            }

            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>

    <div class="login-container" id="loginGateway">
        <h1>SYA #BlackLives: The GLR Black London Collection</h1>
        <div class="login-form">
            <input type="text" id="tokenInput" placeholder="Enter credentials">
            <button onclick="attemptLoginWithToken()">Login</button>
            <p id="loginError" class="login-error"></p>
        </div>
    </div>

    <div class="main-content-wrapper" id="mainContentWrapper" style="display: none;">
        <div class="video-column">
            <div class="featured-video">
                <div id="featuredIframe"></div>
            </div>

            <div class="search-container">
                <input type="text" id="videoSearchInput" placeholder="Search titles, descriptions, or tags...">
                <p class="search-message">Use the **search bar** to filter the video collection by metadata found in the title, descriptions, and tags.
                <br>For more in-depth, contextual insights directly within video content—in natural language—use the **Ask AI tab in-player**.</p>
            </div>
            <h2>Available Reels</h2>
            <div class="video-grid" id="videoGrid"></div>
        </div>

        <div class="article-column">
            <p>The "GLR Black London" reels offer a vibrant and nuanced historical record, revealing:</p>
            <h3>Political and Social Activism:</h3>
            <p>The archives vividly document the ongoing struggle for civil rights and fair representation in the UK. We see discussions on "race equality, immigration rules, and voting rights for immigrants" amidst "rising racism" and "anticipated violence in 1992" <span class="reel-reference">(BL_005)</span>. The echoes of global movements, like the Rodney King case and subsequent London protests <span class="reel-reference">(BL_020)</span>, highlight interconnectedness. Key moments include the appointment of Herman Ouseley as the first Black chairman of the Commission for Racial Equality <span class="reel-reference">(BL_009)</span> and discussions around police "cultural awareness training" <span class="reel-reference">(BL_014)</span>.</p>
            <h3>Addressing Systemic Racism and Discrimination:</h3>
            <p>The collection unflinchingly exposes systemic issues within British society. The **Criminal Justice System** is a recurring focus, with content examining the "impact of the Criminal Justice Act on Black individuals" <span class="reel-reference">(BL_008)</span> and calls for "anti-racist training" <span class="reel-reference">(BL_020)</span>. For context, in 2022, Black defendants in England and Wales were **more likely to receive a custodial sentence** than White British defendants, even when controlling for other factors (Ministry of Justice, 2022). Black prisoners also served a **greater proportion of their original sentence in custody** (68% in 2022) compared to White prisoners (59%). Concerns about **Health Disparities** are explicitly mentioned, particularly "health disparities among Black women" <span class="reel-reference">(BL_008)</span> and within the "justice system" <span class="reel-reference">(BL_004)</span>. For instance, Black women in the UK face an almost **three-fold higher risk of maternal mortality** compared to White women. We also find evidence of **Underrepresentation**. In the UK Civil Service as of March 2024, only **4.5% of civil servants whose ethnicity was known were Black**, compared to 80.7% of the working-age population identifying as White in the 2021 Census. Local "**Housing/Community Issues**" in Brixton <span class="reel-reference">(BL_020)</span> further paint a picture of racial tensions.</p>
            <h3>Powerful Activism & Advocacy:</h3>
            <p>The archives document various forms of community-led initiatives and advocacy. The "**Black Camden Sisters**'" efforts to support women facing domestic violence <span class="reel-reference">(BL_003)</span> and Dr. Abiola's call for "**unity and independent organization within African communities**" <span class="reel-reference">(BL_008)</span> demonstrate powerful agency. Protests for justice reform <span class="reel-reference">(BL_020)</span> are also prominently featured. In London, domestic abuse incidents remain high; for instance, out of nearly 400,000 cases in the past four years, only **one in ten led to positive outcomes** like a charge or caution.</p>
            <h3>Celebrating Cultural Identity:</h3>
            <p>These materials richly portray Black arts and culture, including ITV's "new projects supporting Black arts and culture" <span class="reel-reference">(BL_009)</span>, the role of "**Black theater**" <span class="reel-reference">(BL_005)</span>, and various African film series <span class="reel-reference">(BL_011)</span>, <span class="reel-reference">(BL_021)</span>. We also see the influence of musical giants like **Fela Kuti** <span class="reel-reference">(BL_009)</span>, whose Afrobeat revolutionized music, and the cinematic impact of figures like **Melvin Van Peebles** <span class="reel-reference">(BL_004)</span>, who pioneered Blaxploitation cinema. The contributions of **Quincy Jones** across music and film are also vital to acknowledge. Discussions on "**Historical Contributions**" <span class="reel-reference">(BL_013)</span> are vital for representation, highlighting "**overlooked achievements**" of Black figures and the need to "recognize Black inventors like **Garrett Morgan** and **Louis Latimer**" <span class="reel-reference">(BL_013)</span>. "**Community Events**" like the Leicester Carnival <span class="reel-reference">(BL_011)</span>, <span class="reel-reference">(BL_021)</span> and the Brixton Song Contest <span class="reel-reference">(BL_015)</span> further celebrating multiculturalism. The **Power of Art and Culture** is a dominant theme across music, film, poetry, and theatre.</p>
            <p>Beyond preservation, the collection offers immense potential for future documentary practice, academic research, and public engagement related to the Black British experience. Key themes include:</p>
            <ul>
                <li><strong>The Continuum of Black Struggle and Resilience:</strong> These archives provide a powerful narrative of ongoing struggle against oppression, interwoven with stories of resilience, advocacy, and cultural celebration within a British context.</li>
                <li><strong>Societal Challenges & Human Stories:</strong> The collection highlights significant societal challenges, from recurring themes of **Domestic Violence** <span class="reel-reference">(BL_003)</span>, <span class="reel-reference">(BL_014)</span>, <span class="reel-reference">(BL_040)</span> and touches on **Mental Health & Addiction** <span class="reel-reference">(BL_027)</span>, <span class="reel-reference">(BL_029)</span>, to **Challenges Faced by Vulnerable Groups** <span class="reel-reference">(BL_012)</span>, <span class="reel-reference">(BL_015)</span>. We also find explorations of **Ethical Dilemmas in Science & Society** <span class="reel-reference">(BL_002)</span>, <span class="reel-reference">(BL_038)</span>, <span class="reel-reference">(BL_039)</span>.</li>

                <li><strong>UK Specific Issues & Institutions:</strong> The archives provide granular detail on UK-specific concerns, including **British Politics & Governance** <span class="reel-reference">(BL_004)</span>, <span class="reel-reference">(BL_005)</span>, <span class="reel-reference">(BL_009)</span>, **Police and Community Relations** <span class="reel-reference">(BL_006)</span>, <span class="reel-reference">(BL_026)</span>, and **Infrastructure & Economy** issues <span class="reel-reference">(BL_007)</span>, <span class="reel-reference">(BL_009)</span>, <span class="reel-reference">(BL_012)</span>, <span class="reel-reference">(BL_004)</span>, <span class="reel-reference">(BL_024)</span>, <span class="reel-reference">(BL_029)</span>.</li>
            </ul>
        </div>
    </div>

    <script>
        // !! WARNING: For demonstration purposes only. Do NOT expose your access token in production client-side code. !!
        // !!          For production, implement server-side authentication and API calls to protect your token. !!
        let VIMEO_ACCESS_TOKEN = null;
        const VIMEO_PROJECT_ID = "25424026"; // <--- REPLACE WITH YOUR ACTUAL VIMEO PROJECT ID

        let videoReferenceMap = new Map(); // Global map to store video data by BL_XXX ID
        let allFetchedVideos = []; // Global array to store all fetched videos

        // --- Login Gateway Functions ---
        async function attemptLoginWithToken() {
            const tokenInput = document.getElementById('tokenInput').value.trim();
            const loginError = document.getElementById('loginError');

            if (!tokenInput) {
                loginError.textContent = "Please enter an access token.";
                return;
            }

            VIMEO_ACCESS_TOKEN = tokenInput;

            try {
                // 1. Validate token by fetching user info (basic check)
                const testUrl = `https://api.vimeo.com/me?fields=uri`;
                const response = await fetch(testUrl, {
                    headers: {
                        'Authorization': `Bearer ${VIMEO_ACCESS_TOKEN}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Authentication failed (Status: ${response.status}).`);
                }

                // 2. Proceed to fetch and display videos
                document.getElementById('loginGateway').style.display = 'none';
                document.getElementById('mainContentWrapper').style.display = 'flex'; // Changed to mainContentWrapper
                fetchAllVimeoVideosAndDisplay();

            } catch (error) {
                console.error('Login failed:', error);
                let errorMessage = error.message;
                loginError.textContent = `Login failed: ${errorMessage}`;
                VIMEO_ACCESS_TOKEN = null;
            }
        }

        // --- Vimeo API Functions to fetch ALL videos ---
        async function fetchAllVimeoVideosAndDisplay() {
            if (!VIMEO_ACCESS_TOKEN) {
                console.error("No Vimeo access token available. Login required.");
                return;
            }

            allFetchedVideos = []; // Reset global array
            let currentPageUrl = `https://api.vimeo.com/me/projects/${VIMEO_PROJECT_ID}/videos?fields=uri,name,tags,description,pictures.sizes,embed.html&per_page=100`;

            try {
                while (currentPageUrl) {
                    const response = await fetch(currentPageUrl, {
                        headers: {
                            'Authorization': `Bearer ${VIMEO_ACCESS_TOKEN}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            document.getElementById('mainContentWrapper').innerHTML = `<p style="color: red; text-align: center;">Access Denied. Your token might be invalid or lack permissions for this project. <br> Please check your token permissions or project ID.</p>`;
                            console.error(`Vimeo API Error: Status ${response.status}. Check token permissions or project ID.`);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    allFetchedVideos = allFetchedVideos.concat(data.data);
                    currentPageUrl = data.paging.next;

                    // Optional: Add a small delay between requests to avoid hitting rate limits
                    // if (currentPageUrl) {
                    //      await new Promise(resolve => setTimeout(resolve, 200));
                    // }
                }

                console.log("Total Vimeo Videos fetched:", allFetchedVideos.length);
                if (allFetchedVideos.length > 0) {
                    console.log("Example of first video's embed.html:", allFetchedVideos[0].embed?.html);
                } else {
                    console.log("No videos fetched from the project.");
                }

                // Sort videos numerically by the number in their name once after fetching all
                allFetchedVideos.sort((a, b) => {
                    const nameA = a.name || "";
                    const nameB = b.name || "";
                    try {
                        const numA = parseFloat(nameA.replace("BLACKLIVES_BL_", "").replace("_Vimeo", ""));
                        const numB = parseFloat(nameB.replace("BLACKLIVES_BL_", "").replace("_Vimeo", ""));
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return numA - numB;
                        }
                    } catch (e) { /* Fallback to string comparison if numerical parsing fails */ }
                    return nameA.localeCompare(b.name || "");
                });

                // Populate videoReferenceMap
                videoReferenceMap.clear(); // Clear previous entries
                allFetchedVideos.forEach(video => {
                    const videoName = video.name || "";
                    const match = videoName.match(/BL_\d+/);
                    if (match) {
                        const blId = match[0]; // e.g., "BL_005"
                        videoReferenceMap.set(blId, video);
                    }
                });

                displayFilteredVideos(allFetchedVideos); // Display all videos initially
                linkReelReferences(); // Call the new function to link article references

                // Add event listener for search input
                document.getElementById('videoSearchInput').addEventListener('input', filterVideos);

            } catch (error) {
                console.error('Error fetching Vimeo videos:', error);
                document.getElementById('mainContentWrapper').innerHTML = `<p style="color: red; text-align: center;">Failed to load videos. Please check your network, token, or project ID.</p>`;
            }
        }

        // --- Function to display videos in the grid (can be used for filtered results) ---
        function displayFilteredVideos(videosToDisplay) {
            const featuredIframeContainer = document.getElementById('featuredIframe');
            const videoGrid = document.getElementById('videoGrid');

            videoGrid.innerHTML = ''; // Clear existing grid content

            if (videosToDisplay.length === 0) {
                videoGrid.innerHTML = '<p style="text-align: center; color: var(--text-light); width: 100%;">No videos found matching your search criteria.</p>';
                // Optionally clear or show a default in the featured player if no videos are found
                if (allFetchedVideos.length > 0) {
                    // If no search matches, but there are overall videos, show the first overall video
                    updateFeaturedPlayer(allFetchedVideos[0].uri.split('/').pop(), allFetchedVideos[0].embed?.html);
                } else {
                    featuredIframeContainer.innerHTML = '<p style="text-align: center; color: var(--text-light);">No videos found in this project.</p>';
                }
                return;
            }

            // Ensure the featured player is updated with the first video from the *filtered* list
            const firstVideoInFilteredList = videosToDisplay[0];
            updateFeaturedPlayer(firstVideoInFilteredList.uri.split('/').pop(), firstVideoInFilteredList.embed?.html);


            videosToDisplay.forEach(video => {
                const videoItem = document.createElement('div');
                videoItem.classList.add('video-item');
                videoItem.dataset.videoId = video.uri.split('/').pop();

                const videoInfo = document.createElement('div');
                videoInfo.classList.add('video-item-info');

                const titleElement = document.createElement('h3');
                titleElement.textContent = video.name.replace(/_Vimeo$/, '');
                videoInfo.appendChild(titleElement);

                const descriptionElement = document.createElement('p');
                descriptionElement.classList.add('description');
                descriptionElement.textContent = video.description || "No description provided.";
                videoInfo.appendChild(descriptionElement);

                const approxMaxChars = 100; // Character limit for truncation
                if (descriptionElement.textContent.length > approxMaxChars) {
                    descriptionElement.classList.add('truncated');
                    const readMoreBtn = document.createElement('button');
                    readMoreBtn.classList.add('read-more-btn');
                    readMoreBtn.textContent = 'Read More';
                    readMoreBtn.addEventListener('click', (event) => {
                        event.stopPropagation(); // Prevent the video item click from firing
                        toggleDescription(descriptionElement, readMoreBtn);
                    });
                    videoInfo.appendChild(readMoreBtn);
                }

                // --- Display Tags ---
                if (video.tags && video.tags.length > 0) {
                    const tagsContainer = document.createElement('div');
                    tagsContainer.classList.add('video-tags');
                    video.tags.forEach(tag => {
                        const tagSpan = document.createElement('span');
                        tagSpan.textContent = tag.name;
                        tagsContainer.appendChild(tagSpan);
                    });
                    videoInfo.appendChild(tagsContainer);
                }

                videoItem.appendChild(videoInfo);

                // Add click listener to whole item to change featured video
                videoItem.addEventListener('click', () => {
                    updateFeaturedPlayer(video.uri.split('/').pop(), video.embed?.html);
                });

                videoGrid.appendChild(videoItem);
            });
        }

        // --- Function to filter videos based on search input ---
        function filterVideos() {
            const searchTerm = document.getElementById('videoSearchInput').value.toLowerCase();
            const filtered = allFetchedVideos.filter(video => {
                const title = (video.name || "").toLowerCase();
                const description = (video.description || "").toLowerCase();
                const tags = (video.tags || []).map(tag => tag.name.toLowerCase()).join(' ');

                return title.includes(searchTerm) ||
                       description.includes(searchTerm) ||
                       tags.includes(searchTerm);
            });
            displayFilteredVideos(filtered);
        }

        // --- Function to update the featured player ---
        function updateFeaturedPlayer(videoId, embedHtml) {
            const featuredIframeContainer = document.getElementById('featuredIframe');
            featuredIframeContainer.innerHTML = '';

            const videoIframe = document.createElement('iframe');
            let finalVideoSrc = `https://player.vimeo.com/video/${videoId}`; // Default base URL

            // Prioritize parsing SRC from Vimeo's embed.html if available.
            // This is how Vimeo handles embed settings and privacy hashes.
            if (embedHtml) {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(embedHtml, 'text/html');
                    const iframeElement = doc.querySelector('iframe');
                    if (iframeElement && iframeElement.src) {
                        finalVideoSrc = iframeElement.src;
                    }
                } catch (e) {
                    console.warn(`WARN: Could not parse embed.html for video ${videoId}. Error: ${e.message}`);
                }
            }

            // Ensure autoplay and loop are always set for the featured player.
            const url = new URL(finalVideoSrc);
            url.searchParams.set('autoplay', '1');
            url.searchParams.set('loop', '0');
            // If you want to explicitly hide byline, portrait, title, add them here:
            // url.searchParams.set('byline', '0');
            // url.searchParams.set('portrait', '0');
            // url.searchParams.set('title', '0');

            finalVideoSrc = url.toString(); // Convert the URL object back to a string

            videoIframe.src = finalVideoSrc;
            videoIframe.frameBorder = '0';
            videoIframe.allow = 'autoplay; fullscreen; picture-in-picture';
            videoIframe.allowFullscreen = true;
            videoIframe.dataset.videoId = videoId;
            featuredIframeContainer.appendChild(videoIframe);

            window.scrollTo({
                top: document.getElementById('featuredIframe').offsetTop - 20,
                behavior: 'smooth'
            });
            console.log(`DEBUG: Player loaded for video ${videoId}. Final SRC: ${finalVideoSrc}.`);
        }


        // --- Helper function to get thumbnail URL (no longer directly used but kept for completeness if needed) ---
        function getThumbnailUrl(pictures) {
            const sortedSizes = pictures.filter(p => p.width).sort((a, b) => b.width - a.width);
            if (sortedSizes.length > 0) {
                const suitableSize = sortedSizes.find(size => size.width >= 640) || sortedSizes[0];
                return suitableSize.link;
            }
            return 'https://via.placeholder.com/640x360?text=No+Thumbnail'; // Generic fallback image
        }

        // --- Helper function to toggle description visibility ---
        function toggleDescription(descriptionElement, buttonElement) {
            if (descriptionElement.classList.contains('truncated')) {
                descriptionElement.classList.remove('truncated');
                buttonElement.textContent = 'Read Less';
            } else {
                descriptionElement.classList.add('truncated');
                buttonElement.textContent = 'Read More';
            }
        }

        // --- Function to link reel references in the article column ---
        function linkReelReferences() {
            const reelReferences = document.querySelectorAll('.article-column .reel-reference');
            reelReferences.forEach(span => {
                const textContent = span.textContent.trim(); // e.g., "(BL_005)"
                const match = textContent.match(/BL_\d+/);
                if (match) {
                    const blId = match[0]; // e.g., "BL_005"
                    const video = videoReferenceMap.get(blId);
                    if (video) {
                        span.style.cursor = 'pointer';
                        span.style.textDecoration = 'underline';
                        span.style.color = 'var(--primary-blue)'; // Blue like a link
                        span.addEventListener('click', (event) => {
                            event.stopPropagation(); // Prevent the video item click from firing
                            updateFeaturedPlayer(video.uri.split('/').pop(), video.embed?.html);
                        });
                        // Add hover effect for consistency with other links
                        span.addEventListener('mouseover', () => {
                            span.style.color = 'var(--primary-blue-dark)'; // Darker blue on hover
                        });
                        span.addEventListener('mouseout', () => {
                            span.style.color = 'var(--primary-blue)'; // Back to original blue
                        });
                    } else {
                        console.warn(`Video for reference ${blId} not found in collection.`);
                    }
                }
            });
        }
    </script>
</body>
</html>
